table_name,view_definition,use_standard_sql,sys_time
ga_realtime_sessions_view_136864690,"SELECT *
FROM `minutemediadwh.136864690.ga_realtime_sessions_2020*` 
WHERE _TABLE_SUFFIX = FORMAT_DATE('%m%d', CURRENT_DATE())
AND exportKey in (   SELECT exportKey FROM   
(     SELECT exportKey, exportTimeUsec, MAX(exportTimeUsec) OVER (PARTITION BY visitKey) AS maxexportTimeUsec 
FROM `minutemediadwh.136864690.ga_realtime_sessions_2020*`  WHERE _TABLE_SUFFIX = FORMAT_DATE('%m%d', CURRENT_DATE())  )   WHERE exportTimeUsec >= maxexportTimeUsec )

",YES,2021-07-18 16:33:47.094433
ga_realtime_sessions_view_177343,"SELECT *
FROM `minutemediadwh.177343.ga_realtime_sessions_2020*` 
WHERE _TABLE_SUFFIX = FORMAT_DATE('%m%d', CURRENT_DATE())
AND exportKey in (   SELECT exportKey FROM   
(     SELECT exportKey, exportTimeUsec, MAX(exportTimeUsec) OVER (PARTITION BY visitKey) AS maxexportTimeUsec 
FROM `minutemediadwh.177343.ga_realtime_sessions_2020*`  WHERE _TABLE_SUFFIX = FORMAT_DATE('%m%d', CURRENT_DATE())  )   WHERE exportTimeUsec >= maxexportTimeUsec )",YES,2021-07-18 16:33:47.094433
queries_cost_test_v,"select 
protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobConfiguration.query.query	as jobConfiguration_query,
protopayload_auditlog.servicedata_v1_bigquery.jobQueryRequest.query as jobQueryRequest_query,
sum(protopayload_auditlog.servicedata_v1_bigquery.jobQueryResponse.job.jobStatistics.totalBilledBytes)/pow(1024,4),
(sum(protopayload_auditlog.servicedata_v1_bigquery.jobQueryResponse.job.jobStatistics.totalBilledBytes)/pow(1024,4))*5.00,
sum(protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.totalBilledBytes )/pow(1024,4),
(sum(protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatistics.totalBilledBytes )/pow(1024,4))*5.00,

sum(protopayload_auditlog.servicedata_v1_bigquery.jobGetQueryResultsResponse.job.jobStatistics.totalBilledBytes )/pow(1024,4),
(sum(protopayload_auditlog.servicedata_v1_bigquery.jobGetQueryResultsResponse.job.jobStatistics.totalBilledBytes )/pow(1024,4))*5.00,

sum(protopayload_auditlog.servicedata_v1_bigquery.jobInsertRequest.resource.jobStatistics.totalBilledBytes )/pow(1024,4),
(sum(protopayload_auditlog.servicedata_v1_bigquery.jobInsertRequest.resource.jobStatistics.totalBilledBytes )/pow(1024,4))*5.00,

sum(protopayload_auditlog.servicedata_v1_bigquery.jobInsertResponse.resource.jobStatistics.totalBilledBytes )/pow(1024,4),
(sum(protopayload_auditlog.servicedata_v1_bigquery.jobInsertResponse.resource.jobStatistics.totalBilledBytes )/pow(1024,4))*5.00,

sum(protopayload_auditlog.servicedata_v1_bigquery.jobQueryDoneResponse.job.jobStatistics.totalBilledBytes  )/pow(1024,4),
(sum(protopayload_auditlog.servicedata_v1_bigquery.jobQueryDoneResponse.job.jobStatistics.totalBilledBytes  )/pow(1024,4))*5.00

from `minutemediadwh.AuditLogs.cloudaudit_googleapis_com_data_access_20200314`
where protopayload_auditlog.servicedata_v1_bigquery.jobQueryResponse.job.jobStatistics.totalBilledBytes is not null
group by 1,2
;",YES,2021-07-18 16:33:47.094433
quality_score_final_query,"Select *, 
CASE WHEN ads_to_embeds is not null and firstplay_to_player_embed is not null and video_25_to_first_play is not null
THEN CPM_SCORE*0.15 + CTR_SCORE*0.125 + VIEWABILITY_SCORE*0.08 + ADS_TO_EMBEDS_SCORE*0.16 + FIRSTPLAY_TO_EMBED_SCORE*0.105 + VIDEO_25_TO_FIRST_PLAY_SCORE*0.16 + FILL_SCORE*0.07 + IVT_SCORE*0.15 
ELSE CPM_SCORE*0.4 + CTR_SCORE*0.25 + VIEWABILITY_SCORE*0.2 + + FILL_SCORE*0.15  
END AS Final_Score, 
CASE WHEN ads_to_embeds is not null THEN 'Including GA Score'
ELSE 'Only DFP Score' END AS Score_source
from 
(SELECT 
MMPartner, 
Revenue_tiers, 
Revenue_adj as Revenue, 
Impressions_adj as Impressions,
viewable_impressions_adj as viewable_impressions,
clicks_adj as clicks, 
player_embed_full_adj, 
player_embed_is_bot_adj, 
player_embed_adj, 
video_25_complete_adj, 
first_play_adj,
ga_impressions_adj, 
ad_requests_adj, 
VAST_error_301_count, 
VAST_error_303_count,
VAST_error_901_count,
VAST_error_900_count,
fillrate_impressions_adj as fillrate_impressions,
unfilled_impressions_adj as unfilled_impressions,
Site, 
CPM, 
CTR,
ads_to_embeds,
viewability,
video_25_to_first_play,
firstplay_to_player_embed,
IVT, 
fill_rate, 
avg_cpm,

CASE WHEN CPM <= 0.25 * avg_cpm THEN 1
     WHEN CPM BETWEEN avg_cpm * 0.25 AND avg_cpm * 0.5 THEN 4
     WHEN CPM BETWEEN avg_cpm * 0.5 AND 0.75 * avg_cpm THEN 5
     WHEN CPM BETWEEN avg_cpm * 0.75 AND avg_cpm THEN 6
     WHEN CPM BETWEEN avg_cpm AND 1.25 * avg_cpm THEN 7
     WHEN CPM BETWEEN avg_cpm * 1.25 AND 1.5 * avg_cpm THEN 8
     WHEN CPM >= avg_cpm * 1.5  THEN 9
     ELSE null END AS CPM_SCORE, 

CASE WHEN CTR <= 0.25 * avg_ctr THEN 1
     WHEN CTR BETWEEN avg_ctr * 0.25 AND avg_ctr * 0.5 THEN 4
     WHEN CTR BETWEEN avg_ctr * 0.5 AND 0.75 * avg_ctr THEN 5
     WHEN CTR BETWEEN avg_ctr * 0.75 AND avg_ctr THEN 6
     WHEN CTR BETWEEN avg_ctr AND 1.25 * avg_ctr THEN 7
     WHEN CTR BETWEEN avg_ctr * 1.25 AND 1.5 * avg_ctr THEN 8
     WHEN CTR >= avg_ctr * 1.5  THEN 9
     ELSE null END AS CTR_SCORE, 

CASE WHEN viewability <= 0.25 * avg_viewability THEN 1
     WHEN viewability BETWEEN avg_viewability * 0.25 AND avg_viewability * 0.5 THEN 4
     WHEN viewability BETWEEN avg_viewability * 0.5 AND 0.75 * avg_viewability THEN 5
     WHEN viewability BETWEEN avg_viewability * 0.75 AND avg_viewability THEN 6
     WHEN viewability BETWEEN avg_viewability AND 1.25 * avg_viewability THEN 7
     WHEN viewability BETWEEN avg_viewability * 1.25 AND 1.5 * avg_viewability THEN 8
     WHEN viewability >= avg_viewability * 1.5  THEN 9
     ELSE null END AS VIEWABILITY_SCORE, 

CASE WHEN ads_to_embeds <= 0.25 * avg_ads_to_embeds THEN 1
     WHEN ads_to_embeds BETWEEN avg_ads_to_embeds * 0.25 AND avg_ads_to_embeds * 0.5 THEN 4
     WHEN ads_to_embeds BETWEEN avg_ads_to_embeds * 0.5 AND 0.75 * avg_ads_to_embeds THEN 5
     WHEN ads_to_embeds BETWEEN avg_ads_to_embeds * 0.75 AND avg_ads_to_embeds THEN 6
     WHEN ads_to_embeds BETWEEN avg_ads_to_embeds AND 1.25 * avg_ads_to_embeds THEN 7
     WHEN ads_to_embeds BETWEEN avg_ads_to_embeds * 1.25 AND 1.5 * avg_ads_to_embeds THEN 8
     WHEN ads_to_embeds >= avg_ads_to_embeds * 1.5  THEN 9
     ELSE null END AS ADS_TO_EMBEDS_SCORE, 


CASE WHEN firstplay_to_player_embed <= 0.25 * avg_firstplay_to_player_embed THEN 1
     WHEN firstplay_to_player_embed BETWEEN avg_firstplay_to_player_embed * 0.25 AND avg_firstplay_to_player_embed * 0.5 THEN 4
     WHEN firstplay_to_player_embed BETWEEN avg_firstplay_to_player_embed * 0.5 AND 0.75 * avg_firstplay_to_player_embed THEN 5
     WHEN firstplay_to_player_embed BETWEEN avg_firstplay_to_player_embed * 0.75 AND avg_firstplay_to_player_embed THEN 6
     WHEN firstplay_to_player_embed BETWEEN avg_firstplay_to_player_embed AND 1.25 * avg_firstplay_to_player_embed THEN 7
     WHEN firstplay_to_player_embed BETWEEN avg_firstplay_to_player_embed * 1.25 AND 1.5 * avg_firstplay_to_player_embed THEN 8
     WHEN firstplay_to_player_embed >= avg_firstplay_to_player_embed * 1.5  THEN 9
     ELSE null END AS FIRSTPLAY_TO_EMBED_SCORE, 


CASE WHEN video_25_to_first_play <= 0.25 * avg_video_25_to_first_play THEN 1
     WHEN video_25_to_first_play BETWEEN avg_video_25_to_first_play * 0.25 AND avg_video_25_to_first_play * 0.5 THEN 4
     WHEN video_25_to_first_play BETWEEN avg_video_25_to_first_play * 0.5 AND 0.75 * avg_video_25_to_first_play THEN 5
     WHEN video_25_to_first_play BETWEEN avg_video_25_to_first_play * 0.75 AND avg_video_25_to_first_play THEN 6
     WHEN video_25_to_first_play BETWEEN avg_video_25_to_first_play AND 1.25 * avg_video_25_to_first_play THEN 7
     WHEN video_25_to_first_play BETWEEN avg_video_25_to_first_play * 1.25 AND 1.5 * avg_video_25_to_first_play THEN 8
     WHEN video_25_to_first_play >= avg_video_25_to_first_play * 1.5  THEN 9
     ELSE null END AS VIDEO_25_TO_FIRST_PLAY_SCORE, 

CASE WHEN IVT <= 0.25 * avg_ivt THEN 1
     WHEN IVT BETWEEN avg_ivt * 0.25 AND avg_ivt * 0.5 THEN 4
     WHEN IVT BETWEEN avg_ivt * 0.5 AND 0.75 * avg_ivt THEN 5
     WHEN IVT BETWEEN avg_ivt * 0.75 AND avg_ivt THEN 6
     WHEN IVT BETWEEN avg_ivt AND 1.25 * avg_ivt THEN 7
     WHEN IVT BETWEEN avg_ivt * 1.25 AND 1.5 * avg_ivt THEN 8
     WHEN IVT >= avg_ivt * 1.5  THEN 9
     ELSE null END AS IVT_SCORE, 

CASE WHEN fill_rate <= 0.25 * avg_fill_rate THEN 1
     WHEN fill_rate BETWEEN avg_fill_rate * 0.25 AND avg_fill_rate * 0.5 THEN 4
     WHEN fill_rate BETWEEN avg_fill_rate * 0.5 AND 0.75 * avg_fill_rate THEN 5
     WHEN fill_rate BETWEEN avg_fill_rate * 0.75 AND avg_fill_rate THEN 6
     WHEN fill_rate BETWEEN avg_fill_rate AND 1.25 * avg_fill_rate THEN 7
     WHEN fill_rate BETWEEN avg_fill_rate * 1.25 AND 1.5 * avg_fill_rate THEN 8
     WHEN fill_rate >= avg_fill_rate * 1.5  THEN 9
     ELSE null END AS FILL_SCORE, 






FROM
(
Select 
MMPartner, 
Revenue_tiers,
Site, 
sum(Revenue_adj) as Revenue_adj,
sum(Impressions_adj) as Impressions_adj,
SUM(viewable_impressions_adj) AS viewable_impressions_adj,
SUM(clicks_adj) AS clicks_adj, 
SUM(player_embed_full_adj) as player_embed_full_adj, 
SUM(player_embed_is_bot_adj) as player_embed_is_bot_adj, 
SUM(player_embed_adj) as player_embed_adj, 
SUM(video_25_complete_adj) as video_25_complete_adj, 
SUM(first_play_adj) as first_play_adj,
SUM(ga_impressions_adj) as ga_impressions_adj, 
SUM(ad_requests_adj) as ad_requests_adj, 
SUM(VAST_error_301_count) as VAST_error_301_count, 
SUM(VAST_error_303_count) as VAST_error_303_count,
SUM(VAST_error_901_count) as VAST_error_901_count,
SUM(VAST_error_900_count) as VAST_error_900_count,
SUM(fillrate_impressions_adj) as fillrate_impressions_adj,
SUM(unfilled_impressions_adj) as unfilled_impressions_adj, 
((sum(tier_revenue))*1000)/sum(tier_impressions) as avg_cpm,
(sum(tier_clicks))/sum(tier_impressions) as avg_ctr,
(sum(tier_viewable_impressions))/sum(tier_Impressions) avg_viewability,
(sum(tier_ga_impressions) /sum(tier_ga_impressions) ) as avg_ads_to_embeds, 
(sum(tier_video_25_complete)/ sum(tier_first_play)) as avg_video_25_to_first_play,
(sum(tier_first_play) / sum(tier_player_embed)) as avg_firstplay_to_player_embed,
sum(tier_player_embed_is_bot) / sum(tier_player_embed_full)  as avg_ivt,
sum(tier_fillrate_impressions) / sum(tier_unfilled_impressions + tier_fillrate_impressions) as avg_fill_rate,
round(safe_divide((sum(Revenue_adj)*1000),sum(Impressions_adj)),2) as CPM,
round(safe_divide((sum(clicks_adj)),sum(Impressions_adj)),4) as CTR,
round(safe_divide((sum(viewable_impressions_adj )),sum(Impressions_adj)),2) as viewability,
round(safe_divide((sum(ga_impressions_adj )),sum(player_embed_adj)),2) as ads_to_embeds,
round(safe_divide((sum(video_25_complete_adj )),sum(first_play_adj)),2) as video_25_to_first_play,
round(safe_divide((sum(first_play_adj )),sum(player_embed_adj)),2) as firstplay_to_player_embed,
round(safe_divide((sum(player_embed_is_bot_adj  )),sum(player_embed_full_adj )),4) as IVT,
round(safe_divide((sum(fillrate_impressions_adj )),sum(unfilled_impressions_adj)+sum(fillrate_impressions_adj)),4) as fill_rate,
from

(SELECT 
a.MMPartner as MMPartner, 
Revenue_tiers,
Site, 
sum(Revenue) as Revenue_adj,
sum(Impressions) as Impressions_adj,
SUM(viewable_impressions) AS viewable_impressions_adj,
SUM(clicks) AS clicks_adj, 
SUM(player_embed_full) as player_embed_full_adj, 
SUM(player_embed_is_bot) as player_embed_is_bot_adj, 
SUM(player_embed) as player_embed_adj, 
SUM(video_25_complete) as video_25_complete_adj, 
SUM(first_play) as first_play_adj,
SUM(ga_impressions) as ga_impressions_adj, 
SUM(ad_requests) as ad_requests_adj, 
SUM(VAST_error_301_count) as VAST_error_301_count, 
SUM(VAST_error_303_count) as VAST_error_303_count,
SUM(VAST_error_901_count) as VAST_error_901_count,
SUM(VAST_error_900_count) as VAST_error_900_count,
SUM(fillrate_impressions) as fillrate_impressions_adj,
SUM(unfilled_impressions) as unfilled_impressions_adj,


/*(sum(Revenue)*1000)/sum(Impressions)   over (partition by Revenue_tiers) as avg_cpm, 
(sum(clicks))/ sum(Impressions) over (partition by Revenue_tiers) as avg_ctr, 
(sum(viewable_impressions))/sum(Impressions)  over (partition by Revenue_tiers) as avg_viewability,
(sum(ga_impressions ))/sum(ga_impressions ) over (partition by Revenue_tiers) as avg_ads_to_embeds, 
(sum(video_25_complete ))/sum(first_play) over (partition by Revenue_tiers) as avg_video_25_to_first_play,
(sum(first_play))/ sum(player_embed) over (partition by Revenue_tiers) as avg_firstplay_to_player_embed,
(sum(player_embed_is_bot  ))/ sum(player_embed_full )  over (partition by Revenue_tiers) as avg_ivt,
(sum(fillrate_impressions ))/sum(case when (sum(unfilled_impressions	)+sum(fillrate_impressions)) = 0 then 99999 else (sum(unfilled_impressions)+sum(fillrate_impressions)) end) over (partition by Revenue_tiers) as avg_fill_rate,*/

/*(sum(Revenue)*1000)/sum(case when sum(Impressions) = 0 then 999999 else sum(Impressions) end) over (partition by Revenue_tiers) as avg_cpm, 
(sum(clicks))/sum(case when sum(Impressions) = 0 then 999999 else sum(Impressions) end) over (partition by Revenue_tiers) as avg_ctr, 
(sum(viewable_impressions))/sum(case when sum(Impressions) = 0 then 999999 else sum(Impressions) end) over (partition by Revenue_tiers) as avg_viewability,
(sum(ga_impressions ))/sum(case when sum(ga_impressions ) = 0 then 999999 else sum(ga_impressions ) end) over (partition by Revenue_tiers) as avg_ads_to_embeds, 
(sum(video_25_complete ))/sum(case when sum(first_play) = 0 then 999999 else sum(first_play) end) over (partition by Revenue_tiers) as avg_video_25_to_first_play,
(sum(first_play))/sum(case when sum(player_embed) = 0 then 999999 else sum(player_embed) end) over (partition by Revenue_tiers) as avg_firstplay_to_player_embed,
(sum(player_embed_is_bot  ))/sum(case when sum(player_embed_full ) = 0 then 999999 else sum(player_embed_full ) end) over (partition by Revenue_tiers) as avg_ivt,
(sum(fillrate_impressions ))/sum(case when (sum(unfilled_impressions	)+sum(fillrate_impressions)) = 0 then 99999 else (sum(unfilled_impressions)+sum(fillrate_impressions)) end) over (partition by Revenue_tiers) as avg_fill_rate,*/

sum(Revenue) over (partition by Revenue_tiers) as Tier_Revenue,
sum(Impressions) over (partition by Revenue_tiers) as Tier_Impressions,
sum(clicks) over (partition by Revenue_tiers) as Tier_clicks,
sum(viewable_impressions) over (partition by Revenue_tiers) as Tier_viewable_impressions,
sum(ga_impressions) over (partition by Revenue_tiers) as Tier_ga_impressions,
sum(video_25_complete) over (partition by Revenue_tiers) as Tier_video_25_complete,
sum(first_play) over (partition by Revenue_tiers) as Tier_first_play,
sum(player_embed) over (partition by Revenue_tiers) as Tier_player_embed,
sum(player_embed_full) over (partition by Revenue_tiers) as Tier_player_embed_full,
sum(fillrate_impressions ) over (partition by Revenue_tiers) as Tier_fillrate_impressions ,
sum(unfilled_impressions ) over (partition by Revenue_tiers) as Tier_unfilled_impressions ,
sum(player_embed_is_bot ) over (partition by Revenue_tiers) as tier_player_embed_is_bot




from 
(

/* Revenue Data */     
(Select 
MMPartner, 
Site, 
Advertiser, 
CAST(SUM (CAST(REPLACE(Total_CPM__CPC__CPD_and_vCPM_revenue__US__,',','') AS FLOAT64)) AS FLOAT64) AS Revenue,
  SUM (CAST(REPLACE(total_impressions,',','') AS INT64)) AS Impressions,
  CAST(SUM (CAST(REPLACE(total_active_view_viewable_impressions,',','') AS FLOAT64)) AS FLOAT64) AS viewable_impressions,
  SUM (CAST(REPLACE(total_clicks,',','') AS INT64)) AS clicks, 
CAST(0 AS INT64) as player_embed_full, 
CAST(0 AS INT64) as player_embed_is_bot, 
CAST(0 AS INT64) as player_embed, 
CAST(0 AS INT64) as video_25_complete, 
CAST(0 AS INT64) as first_play,
CAST(0 AS INT64) as ga_impressions, 
CAST(0 AS INT64) as ad_requests, 
CAST(0 AS INT64) as VAST_error_301_count, 
CAST(0 AS INT64) as VAST_error_303_count,
CAST(0 AS INT64) as VAST_error_901_count,
CAST(0 AS INT64) as VAST_error_900_count,
CAST(0 AS INT64) as fillrate_impressions,
CAST(0 AS INT64) as unfilled_impressions,


 FROM 
(SELECT *, LOWER(REPLACE(REPLACE(CASE WHEN ad_unit LIKE '%175840252%' THEN ad_unit ELSE LOWER(CONCAT('175840252 » ',ad_unit)) END,'¬ª','»'),'â','')) AS Ad_units FROM email.a_revenue_dfp_2) a 
  LEFT JOIN (SELECT CASE WHEN DFP_Ad_unit LIKE '%¬ª%' THEN REPLACE(DFP_Ad_unit,'¬ª','»') ELSE DFP_Ad_unit END AS DFP__Ad_unit, MAX(Site) AS Site, MAX(MMPartner) AS MMPartner
       FROM email.a_spend_mmplus_dfp_partnername
       WHERE SUM_Impressions=Max_AdUnit_Impressions
       
       AND Sum_Impressions<>0
       GROUP BY 1)b
       ON a.Ad_units=b.DFP__Ad_unit
  WHERE LOWER (creative_size_delivered_) LIKE '%v%'
  AND (LOWER(Ad_unit) like '%mmplus%' OR LOWER(Ad_unit) like '%pmwz%' OR LOWER(Ad_unit) like '%pmsnz%')
  AND (Advertiser LIKE '-' OR Advertiser LIKE 'ADX')
  AND CAST(CASE WHEN Date LIKE '%2018%' or Date LIKE '%2019%' or Date LIKE '%2020%' or Date LIKE '%2021%' THEN DATE(CAST(Date AS DATE))
       ELSE DATE(CAST(CONCAT('20',regexp_extract(Date,'\\/[0-9]+\\/([0-9]+)'),'-',regexp_extract(Date,'\\/([^\\/]+)'),'-',regexp_extract(Date,'([^\\/]+)')) AS DATE)) END AS DATE) >= CAST(DATE('2021-02-01') AS DATE) 
AND CAST((CAST(REPLACE(Total_CPM__CPC__CPD_and_vCPM_revenue__US__,',','') AS FLOAT64)) AS FLOAT64) > 0 
AND (CAST(REPLACE(total_impressions,',','') AS INT64)) > 0
 group by 1,2,3) 



UNION ALL

/* GA Data */
(SELECT partner_name,
case when lower(player_name) like '%ranker%' then 'www.ranker.com'
else partner_domain end as site, 
 'NA' as Advertiser, 
CAST(0 AS FLOAT64) as Revenue, 
CAST(0 AS INT64) as Impressions,
CAST(0 AS INT64) as viewable_impressions,
CAST(0 AS INT64) as clicks,
sum(player_embed_full) as player_embed_full, 
sum(player_embed_is_bot) as player_embed_is_bot, 
sum(player_embed) as player_embed, 
sum(video_25_complete) as video_25_complete, 
sum(first_play) as first_play,
sum(ad_impressions) as ga_impressions, 
sum(ad_requests) as ad_requests,  
CAST(0 AS INT64) as VAST_error_301_count, 
CAST(0 AS INT64) as VAST_error_303_count,
CAST(0 AS INT64) as VAST_error_901_count,
CAST(0 AS INT64) as VAST_error_900_count,
CAST(0 AS INT64) as fillrate_impressions,
CAST(0 AS INT64) as unfilled_impressions,

FROM `minutemediadwh.email.b_video_stats_full_2` 
WHERE data_date >= ""2021-02-01"" 
AND (ad_impressions) > 0 AND player_embed > 0 and first_play > 0
AND (LOWER(player_name) LIKE 'mm+ %'
or LOWER(player_name) LIKE 'pmwz %'
or LOWER(player_name) LIKE 'pmsnz %')
group by 1,2,3)

UNION ALL 

/* Fill Rate */ 
(Select 
MMPartner, 
Site, 
'NA' as Advertiser, 

CAST(0 AS FLOAT64) as Revenue, 
CAST(0 AS INT64) as Impressions,
CAST(0 AS INT64) as viewable_impressions,
CAST(0 AS INT64) as clicks,
CAST(0 AS INT64) as player_embed_full, 
CAST(0 AS INT64) as player_embed_is_bot, 
CAST(0 AS INT64) as player_embed, 
CAST(0 AS INT64) as video_25_complete, 
CAST(0 AS INT64) as first_play,
CAST(0 AS INT64) as ga_impressions, 
CAST(0 AS INT64) as ad_requests,
sum(VAST_error_301_count) as VAST_error_301_count, 
sum(VAST_error_303_count) as VAST_error_303_count,
sum(VAST_error_901_count) as VAST_error_901_count,
sum(VAST_error_900_count) as VAST_error_900_count,
CAST(0 AS INT64) as fillrate_impressions,
CAST(0 AS INT64) as unfilled_impressions,
 from 
 (SELECT *, LOWER(REPLACE(REPLACE(CASE WHEN ad_unit LIKE '%175840252%' THEN ad_unit ELSE LOWER(CONCAT('175840252 » ',ad_unit)) END,'¬ª','»'),'â','')) AS Ad_units FROM email.video_errors_dfp) a 
  LEFT JOIN (SELECT CASE WHEN DFP_Ad_unit LIKE '%¬ª%' THEN REPLACE(DFP_Ad_unit,'¬ª','»') ELSE DFP_Ad_unit END AS DFP__Ad_unit, MAX(Site) AS Site, MAX(MMPartner) AS MMPartner
       FROM email.a_spend_mmplus_dfp_partnername
       WHERE SUM_Impressions=Max_AdUnit_Impressions   
       AND Sum_Impressions<>0
       GROUP BY 1)b
       ON a.Ad_units=b.DFP__Ad_unit
  WHERE (LOWER(Ad_unit) like '%mmplus%' OR LOWER(Ad_unit) like '%pmwz%' OR LOWER(Ad_unit) like '%pmsnz%')
  AND Date >= CAST(DATE('2021-02-01') AS DATE) AND VAST_error_301_count > 0 
  group by 1,2,3)

UNION ALL 

(SELECT
MMPartner, 
Site, 
'NA' as Advertiser, 
CAST(0 AS FLOAT64) as Revenue, 
CAST(0 AS INT64) as Impressions,
CAST(0 AS INT64) as viewable_impressions,
CAST(0 AS INT64) as clicks,
CAST(0 AS INT64) as player_embed_full, 
CAST(0 AS INT64) as player_embed_is_bot, 
CAST(0 AS INT64) as player_embed, 
CAST(0 AS INT64) as video_25_complete, 
CAST(0 AS INT64) as first_play,
CAST(0 AS INT64) as ga_impressions, 
CAST(0 AS INT64) as ad_requests,
CAST(0 AS INT64) as VAST_error_301_count, 
CAST(0 AS INT64) as VAST_error_303_count,
CAST(0 AS INT64) as VAST_error_901_count,
CAST(0 AS INT64) as VAST_error_900_count,
sum(total_impressions) as fillrate_impressions,
sum(Total_unmatched_ad_requests) as unfilled_impressions, 


 from
(SELECT *, LOWER(REPLACE(REPLACE(CASE WHEN ad_unit LIKE '%175840252%' THEN ad_unit ELSE LOWER(CONCAT('175840252 » ',ad_unit)) END,'¬ª','»'),'â','')) AS Ad_units FROM email.fill_rate_qualityscore_daily) a 
  LEFT JOIN (SELECT CASE WHEN DFP_Ad_unit LIKE '%¬ª%' THEN REPLACE(DFP_Ad_unit,'¬ª','»') ELSE DFP_Ad_unit END AS DFP__Ad_unit, MAX(Site) AS Site, MAX(MMPartner) AS MMPartner
       FROM email.a_spend_mmplus_dfp_partnername
       WHERE SUM_Impressions=Max_AdUnit_Impressions
       AND Sum_Impressions<>0
       GROUP BY 1)b
       ON a.Ad_units=b.DFP__Ad_unit
        WHERE Total_unmatched_ad_requests > 0
       GROUP BY 1,2,3)
       
)
 a
    
    LEFT JOIN email.a_spend_mmpl_partner_category b
    ON a.MMPartner = b.MMPartner 
    
    
    group by 1,2,3, Revenue, impressions, viewable_impressions, ga_impressions, video_25_complete, first_play, player_embed, player_embed_full, fillrate_impressions, unfilled_impressions, clicks,player_embed_is_bot)
    group by 1,2,3
    )  )  where revenue > 0 and Revenue_tiers is not null
    


",YES,2021-07-18 16:33:47.094433
partners_inactive_last_30_days,"--Select FORMAT_DATE('%B, %Y', date) as Month, Partner, MMPartner, sum(Revenue) as Revenue from email.a_revenue_total group by 1,2,3 order by 1 desc
Select 
a.MMPartner as MMPartner, 
Revenue_last_30_days,
revenue_previous_30_days

from
(select MMPartner, max(Date), sum(Revenue) as Revenue_last_30_days from email.a_spend_mmpl where Date >= date_add(current_date(), INTERVAL -30 DAY) 
group by 1 having sum(Revenue) <= 10) a
left join 
(select MMPartner, sum(Revenue) as revenue_previous_30_days from email.a_spend_mmpl where Date BETWEEN date_add(current_date(), INTERVAL -70 DAY) and date_add(current_date(), INTERVAL -30 DAY) 
group by 1) b
ON lower(a.MMPartner) = lower(b.MMPartner)
where revenue_previous_30_days >= 200
and a.MMPartner <> 'NA'",YES,2021-07-18 16:33:47.094433
facebook_master_view_all_test,"WITH fb_data AS (
  SELECT     
    COALESCE(campaign_assets_video.campaign_asset_id,campaign_assets_posts.campaign_asset_id) AS fb_campaign_asset_id,
    fb.account                  AS fb_account,
    fb.asset_type               AS fb_asset_type,
    fb.asset_id                 AS fb_asset_id,
    fb.asset_created_at         AS fb_asset_created_at,
    fb.post_message             AS fb_post_message,
    fb.post_permalink_url       AS fb_post_permalink_url,
    fb.post_url                 AS fb_post_url,
    fb.embedded_data_type       AS fb_video_data_type,
    fb.embedded_data_id         AS fb_video_id, 
    fb.video_crossposted_status AS fb_video_crossposted_status,
    fb.metrics_date             AS fb_metrics_date,
    fb.video_length_seconds     AS fb_video_length_seconds,
    fb.video_minutes_viewed     AS fb_video_minutes_viewed,
    fb.video_total_views        AS fb_video_views,
    fb.video_complete_views     AS fb_video_complete_views,
    fb.video_avg_time_watched   AS fb_video_avg_time_watched,
    fb.video_completion_rate    AS fb_video_completion_rate,
    fb.reach                    AS fb_reach,
    fb.impressions              AS fb_impressions,
    fb.clicks                   AS fb_clicks,
    fb.likes                    AS fb_likes,
    fb.shares                   AS fb_shares,
    fb.comments                 AS fb_comments,
    fb.engagements_fb           AS fb_engagements_fb,
    fb.engagement_rate_fb       AS fb_engagement_rate_fb,
    fb.engagements              AS fb_engagements,
    fb.engagement_rate          AS fb_engagement_rate,
    fb.reaction_likes           AS fb_reaction_likes,
    fb.reaction_loves           AS fb_reaction_loves,
    fb.reaction_wows            AS fb_reaction_wows,
    fb.reaction_hahas           AS fb_reaction_hahas,
    fb.reaction_sorries         AS fb_reaction_sorries,
    fb.reaction_angers          AS fb_reaction_angers
FROM `tpt-platform.insights_platform_views.facebook_posts_videos` AS fb
       LEFT JOIN `tpt-platform.insights_airtable.master_view` AS campaign_assets_video
       ON campaign_assets_video.campaign_asset_fb_videoid = fb.embedded_data_id 
        LEFT JOIN `tpt-platform.insights_airtable.master_view` AS campaign_assets_posts
       ON campaign_assets_posts.campaign_asset_fb_postid = fb.asset_id
)
SELECT
  campaign_assets.campaign_asset_campaign_code,
  campaign_assets.campaign_asset_brand_name,
  campaign_assets.campaign_asset_campaign_name,
  campaign_assets.campaign_asset_id,
  campaign_assets.campaign_asset_title,
  campaign_assets.campaign_asset_contributor,
  campaign_assets.campaign_asset_type,
  campaign_assets.campaign_asset_published,
  campaign_assets.campaign_asset_campaign_stage,
  campaign_assets.campaign_asset_campaign_status,
  campaign_assets.campaign_asset_im_lead,
  campaign_assets.campaign_asset_fb_link,
  campaign_assets.campaign_asset_fb_postid,
  campaign_assets.campaign_asset_fb_videoid,
  campaign_assets.campaign_asset_record_created_at,
  campaign_assets.campaign_asset_record_updated_at,
  campaign_assets.campaign_asset_record_last_loaded_at,
  fb_data.* EXCEPT(fb_campaign_asset_id)
FROM fb_data
LEFT JOIN  `tpt-platform.insights_airtable.master_view` AS campaign_assets
ON campaign_assets.campaign_asset_id = fb_data.fb_campaign_asset_id
ORDER BY campaign_asset_campaign_code desc, campaign_asset_published desc",YES,2021-07-18 16:33:47.094433
